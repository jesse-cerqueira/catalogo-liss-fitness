<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <script  src="createList.js" type="text/javascript"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles/global.css">
  <link rel="stylesheet" href="./styles/category-page.css">

  <style>


    ul {
      padding: 0;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto;
      gap: 1rem;
      flex-wrap: wrap;
      max-width: 1140px;
      margin: 0 auto;

      list-style-type: none;

      li.lista-produto {
        border-radius: 16px;

        overflow: hidden;
        box-shadow: 0px 0px 8px #371f3e17;

        img {
          max-width: 100%;
          height: auto;
          aspect-ratio: 4 / 5;
          object-fit: cover;
        }

        a {
          display: inline-block;
          padding: 20px;
          background-color: #371f3e;
          color: white;
        }

      }
    }
  </style>
</head>
<body>

  <a href="./categorias/category-page.html">Página de categoria</a>
  <ul class="list-products">
  </ul>


<script>
  let productsClean = []; //armazenará o array com produtos >tratados<

  async function fetchProducts (page = 1 , dataProducts = []) {
    const apiEndpoint = `https://lissfitness.com.br/wp-json/wc/v3/products?page=${page}&per_page=100&orderby=title&order=asc&stock_status=instock&consumer_key=ck_148198b90ab9d891ca88eb7368afec072dbe43d0&consumer_secret=cs_6be934eea1423037e5ff3e18ba247bd65a3eb856`;

    console.log(`Fetching page: ${page}`)

    const responseProducts = await fetch(apiEndpoint).then( x => x.json()).catch((e) => {
      console.error(e) // error handling
      return [] //returns no-results
    })

    console.log(`Fetched ${responseProducts.length} ${responseProducts.length !== 1 ? 'items' : "item"} on page ${page}`)

    responseProducts.forEach(product => {
      dataProducts.push(product);
    });

    page++

    if(responseProducts.length >= 100) return fetchProducts(page,dataProducts)
    else return dataProducts
  }

  // Executa a função de receber os itens da API e salvar como .json e gera uma lista tratada a partir das informações obtidas
  fetchProducts().then(products => { 

    let listIteration = []; // Lista que irá guardar todos os nomes (sem a cor) de produtos já processados

    products.forEach(product => {
      // -> extrair a string de cor do nome do produto,
      product.color_variations = product.name.split(/\b(Compressão |Suplex Poliamida |Dryfit |Tule | Trilobal |Jacquard Ondinha |Jacquard Zig |Jacquard Zebra |Jacquard Boreal |Jacquard Spot |Jacquard Chevry )\b/gm).pop();

      // -> extrair a informação de nome do produto até o nome do tecido, e gravar na variavel "name"
      let name = product.name.split(" " + product.color_variations).shift()

      let variationColor = {
        color_name: product.color_variations,
        images: product.images,
        slug: product.slug,
        permalink: product.permalink,
        // date_created: product.date_created,
      }

      let productNew = {
        id: product.id,
        name: name,
        status: product.status,
        sku: product.sku,
        price: product.price,
        price_sale: product.price_sale,
        price_interest: product.price_interest,
        price_interest_sale: product.price_interest_sale,
        on_sale: product.on_sale,
        // stock_status: product.stock_status,
        categories: product.categories,
        images: product.images,
        attributes: product.attributes,
        color_variations: []
      }
      
      // Caso o nome não exista na lista de iteração, fazer algumas coisas
      if (listIteration.indexOf(name) === -1) {

        // Registrar nome na lista de iteração para as próximas conferências em 'products'
        listIteration.push(name = name);

        productNew.color_variations.push(variationColor);
        productsClean.push(productNew);
        
      } 
      else 
      {
        productsClean[productsClean.length - 1].color_variations.push(variationColor);
      }
    });
  });
</script>


</body>
</html>
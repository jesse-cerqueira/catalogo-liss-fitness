<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Legging + Top Tamanho Único – Catálogo Liss Fitness</title>
    <link rel="stylesheet" href="../styles/global.css" />
    <link rel="stylesheet" href="../styles/category-page.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <header class="title-bar">
      <a href="../index.html">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M10.5 19.5L3 12M3 12L10.5 4.5M3 12H21"
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
        </svg>
      </a>
      <h1 class="h5">Legging + Top Tamanho Único</h1>
    </header>

    <ul
      id="list-products"
      style="max-width: 500px; margin: 0 auto; overflow: hidden"
    ></ul>

    <script>
      let whatsappNumber = "999498626";
      let list = document.getElementById("list-products");
      let productsClean = []; //armazenará o array com produtos >tratados<
      let colorsClean = []; //armazenará o array com cores

      // Filtros para cada escolha
      let filter = {
        shortOn  : false,
        leggingOn: true,
        macacaoOn: false,
        blusaOn  : false,
        plusOn   : false,
        unicoOn  : true
      }

      const skuList = {
        legging : ['LBO','LCA','LCL','LCO','LCZ','LDU','LEM','LFA','LLA','LLO','LMO','LRE','LSL','LTR'],
        short   : ['SCL','SBO','SML','SCA','SCL','SCO','SCR','SCZ','SFA','SJE','SLY','SOR','SRE','SSA','SSM','SSN','SDU'],
        macacao : ['MAC','MAQ'],
        blusa   : ['BLU','BLO','CRO','REG','RFC','RCC','BLB']
      }


      async function fetchProducts(products = []) {
        const apiEndpoint = `https://script.google.com/macros/s/AKfycbwpV2W1VNfAJZH9D_UOIoH32aqvihQHP7Q3cDT8ePXdCAC9hdfDyuPW71qH39xn0Ie1/exec`;

        const responseProducts = await fetch(apiEndpoint)
          .then((x) => x.json())
          .catch((e) => {
            console.error(e); // error handling
            return []; //returns no-results
          });
        console.log(
          `Fetched ${responseProducts.length} ${
            responseProducts.length !== 1 ? "items" : "item"
          }`
        );

        if(filter.shortOn){
          baseTipo = 'short';
        }
        else if(filter.leggingOn){
          baseTipo = 'legging';
        }
        else if(filter.macacaoOn){
          baseTipo = 'macacao';
        }
        else {
          baseTipo = 'blusa';
        }

        let listaSelecionada = skuList[baseTipo]

        if(filter.unicoOn){
          baseTamanho = 'TU'
        } else{
          baseTamanho = 'TP'
        }
        

        responseProducts.forEach((product) => {
          if( listaSelecionada.includes(product.SKU1) && product.SKU4 == baseTamanho){
            products.push(product);
          }
        });
        return products
      }

      // Executa a função de receber os itens da API e salvar como .json e gera uma lista tratada a partir das informações obtidas
      fetchProducts().then((products) => {
        console.log('products: ',products)

        let listIteration = []; // Lista que irá guardar todos os nomes únicos de produtos (sem a cor) já processados

        // Gera uma lista "limpa" (productsClean) com os produtos recuperados e tratados
        // Depende de receber os produtos em ordem alfabética para tratar os itens corretamente
        products.forEach((product) => {
          // -> extrair a string de cor do nome do produto,
          product.color_variations = product.NOME
            .split(
              /\b(Animal Print|Compressão e Suplex|Compressão|Dryfit Grid|Dryfit|Jacquard Atol|Jacquard Boreal|Jacquard Canelado|Jacquard Chevry|Jacquard Degradê|Jacquard Felina|Jacquard Isla|Jacquard Ondinha|Jacquard Vulcão|Jacquard Spot|Jacquard Zebra e Trilobal|Jacquard Zebra|Jacquard Zig|Suplex Poliamida|Trilobal|Tule)\b/m
            )
            .pop()
            .trim();

          // -> extrair a string do nome do produto até o nome do tecido, antes de " cor", e gravar a string reusltante na variavel "name"
          let name = product.NOME.split(" " + product.color_variations).shift();

          let variationColor = {
            color_name: product.color_variations,
            color_slug: product.color_variations
              .split(" ")
              .join("-")
              .normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .toLowerCase(),
            images: product.IMG,
            //slug: product.slug,
            //permalink: product.permalink,
            // 'date_created': product.date_created,
          };

          let productNew = {
            id: product.ID,
            name: name,
            status: product.ESTOQUE,
            sku: product.SKU,
            price: (product.PREÇO * 0.9090909090909),
            //price_sale: product.price_sale,
            //price_interest: product.price_interest,
            //price_interest_sale: product.price_interest_sale,
            //on_sale: product.on_sale,
            // 'stock_status': product.stock_status,
            //categories: product.categories,
            images: product.IMG,
            //attributes: product.attributes,
            color_variations: [],
          };

          // Lista as variações únicas de cor em colorsClean
          // if (colorsClean.indexOf(variationColor.color_name) === -1) {
          //   colorsClean.push(variationColor.color_name)
          // }

          // Caso o nome não exista na lista de iteração, fazer algumas coisas
          if (listIteration.indexOf(name) === -1) {
            // Registrar nome na lista de iteração para as próximas conferências em 'products'
            listIteration.push((name = name));

            productNew.color_variations.push(variationColor);
            productsClean.push(productNew);
          } else {
            productsClean[productsClean.length - 1].color_variations.push(
              variationColor
            );
          }
        });

        function swiperVariationImages(arr) {
          return `
          ${arr.images
            .map((image) => {
              return `
              <div class="swiper-slide" data-slide-for-color="${arr.color_name}">
                <div class="swiper-zoom-container">
                  <img src="${image}" width="1600" height="1600" alt="${image.alt}" class="image-product" loading="lazy">
                </div>
              </div>
            `;
            })
            .join("")}
        `;
        }

        function swiperVariations(arr) {
          return `
          ${arr.color_variations
            .map((variation) => {
              return `
              <div class="swiper-slide" data-slide-for-color="${
                variation.slug
              }">
                <div class="swiper swiper-inner">
                  <div class="swiper-wrapper">
                    ${swiperVariationImages(variation)}
                  </div>
                </div>
              </div>
            `;
            })
            .join("")}
        `;
        }

        function swatchesSize(arr) {
          return `
          <div class="wrapper-swatches-size">
            ${arr.attributes[0].options
              .map((size) => {
                return `<div class="swatch-size">${size}</div>`;
              })
              .join("")}
          </div>
        `;
        }

        function swatchesColor(arr) {
          return `
          <div class="wrapper-swatches-color">
            ${arr.color_variations
              .map((color) => {
                return `<div class="swatch-color ${color.color_slug}"></div>`;
              })
              .join("")}
          </div>
        `;
        }

        function productTemplate(product) {
          return `
          <article id="${product.name}" class="wrapper-product">
            <header>
              <h2 class="h5">${product.name} <span class="variation-name">${
            product.color_variations[0].color_name
          }</span></h2>
            </header>
            <div class="product-prices">
              <span class="product-price">R$ <span class="product-price-value">${Number(
                product.price
              ).toFixed(2)}</span></span>
              <span class="product-price-details">no PIX, ou até 3× de R$ <span class="product-price-3x-value">${Number(
                (product.price * 1.1) / 3
              ).toFixed(2)}</span></span>
            </div>
            ${product.color_variations ? swatchesColor(product) : ""}
            
            
            <!--  tamanho 
            $
            {
              product.attributes.find((obj) => obj.name === "TAMANHO")
                ? swatchesSize(product)
                : ""
            }
            -->
            
              <div class="wrapper-sliders-swiper">
                <div class="swiper swiper-outer" data-slide-for="${product.name}">
                  <div class="swiper-wrapper">
                    ${swiperVariations(product)}
                    </div>
                    </div>
            </div>
            <div class="wrapper-actions">
              <a class="btn btn-md btn-primary" href="https://api.whatsapp.com/send?phone=5527${whatsappNumber}&text=Gostaria%20de%20mais%20informações%20sobre%20${
            product.name
          }%20${
            product.color_variations[0].color_name
          }" target="blank">Comprar com atendente</a>
            </div>
          </article>
          `;
        }

        list.innerHTML = `
        ${productsClean.map(productTemplate).join("")}
      `;

        const swiperInner = new Swiper(".swiper-inner", {
          virtual: {
            enabled: true,
            addSlidesAfter: 1,
            addSlidesBefore: 1,
          },
          direction: "horizontal",
          perSlideOffset: 3,
          nested: true,
          effect: "cards",
          rotate: true,
          perSlideRotate: 90,
          zoom: {
            enabled: true,
            toggle: true,
            minRatio: 1,
            maxRatio: 1,
          },
        });

        const swiperOuter = new Swiper(".swiper-outer", {
          virtual: {
            enabled: true,
            addSlidesAfter: 1,
          },
          direction: "horizontal",
          spaceBetween: 20,
        });
        const artigo = Array.from(document.querySelectorAll("article"));
        artigo.forEach((div) => {
          const SwipeOutElement = div.querySelector(".swiper-outer");
          const SwipeOut = SwipeOutElement ? SwipeOutElement.swiper : null;
          const arrySwatchColor = Array.from(
            div.getElementsByClassName("swatch-color")
          );

          arrySwatchColor.forEach((color) => {
            color.addEventListener("click", function () {
              ind = arrySwatchColor.indexOf(color);
              const colorVar = div.querySelector('.variation-name')
//            colorVar.innerHTML = product.color_variations[ind].color_name
              SwipeOut.slideTo(ind, 0);
              
            });
          });
        }); 
      });
    </script>
  </body>
</html>

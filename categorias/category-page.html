<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="../styles/global.css">
  <link rel="stylesheet" href="../styles/category-page.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
</head>

<style>
  .swiper {
    height: auto;
  }
</style>

<body>
<header class="title-bar">
  <a href="../index.html">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10.5 19.5L3 12M3 12L10.5 4.5M3 12H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </a>
  <h1 class="h5">Legging + Top Tamanho Único</h1>
</header>

<ul id="list-products" style="max-width: 500px; margin: 0 auto;">

</ul>

<article class="wrapper-product" hidden>
  <header>
    <h2 class="h5">Nome do Produto</h2>
  </header>
  <div class="product-prices">
    <span class="product-price">R$ <span class="product-price-value">75,00</span></span>
    <span class="product-price-interest">no PIX, ou até 3× de R$ <span class="product-price-3x-value">27,50</span></span>
  </div>
  <div class="wrapper-swatches-color">
    <div class="swatch-color"></div>
    <div class="swatch-color"></div>
    <div class="swatch-color"></div>
    <div class="swatch-color"></div>
    <div class="swatch-color"></div>
  </div>
  <div class="wrapper-swatches-size">
    <div class="swatch-size">P</div>
    <div class="swatch-size">M</div>
    <div class="swatch-size">G</div>
    <div class="swatch-size">GG</div>
  </div>
  <div class="swiper">
    <div class="swiper-wrapper">
      <div class="swiper-slide">
        <img src="https://placehold.co/1600x1600" width="1600" height="1600" class="image-product" alt="">
      </div>
      <div class="swiper-slide">
        <img src="https://placehold.co/1600x1600" width="1600" height="1600" class="image-product" alt="">
      </div>
      <div class="swiper-slide">
        <img src="https://placehold.co/1600x1600" width="1600" height="1600" class="image-product" alt="">
      </div>
      <div class="swiper-slide">
        <img src="https://placehold.co/1600x1600" width="1600" height="1600" class="image-product" alt="">
      </div>
    </div>
  </div>
  <a href="https://api.whatsapp.com/send?phone=5527999498626&text=Tenho%20interesse%20no%20Short%20Snip%20+%20Top%20Tha%C3%ADs%20Compress%C3%A3o%20Lilac,%20https://lissfitness.com.br/loja/conjunto-short/short-snip-top-thais-compressao-lilac/">Comprar com atendente</a>
</article>

<script>
  let whatsappNumber = '999498626'
  let list = document.getElementById('list-products');
  let productsClean = []; //armazenará o array com produtos >tratados<

  async function fetchProducts (page = 1 , dataProducts = [] , category = "16") {
    const apiEndpoint = `https://lissfitness.com.br/wp-json/wc/v3/products?page=${page}&per_page=100&category=${category}&orderby=title&order=asc&stock_status=instock&consumer_key=ck_148198b90ab9d891ca88eb7368afec072dbe43d0&consumer_secret=cs_6be934eea1423037e5ff3e18ba247bd65a3eb856`;

    console.log(`Fetching page: ${page}`)

    const responseProducts = await fetch(apiEndpoint).then( x => x.json()).catch((e) => {
      console.error(e) // error handling
      return [] //returns no-results
    })

    console.log(`Fetched ${responseProducts.length} ${responseProducts.length !== 1 ? 'items' : "item"} on page ${page}`)

    responseProducts.forEach(product => {
      dataProducts.push(product);
    });

    page++

    if(responseProducts.length >= 100) return fetchProducts(page,dataProducts)
    else return dataProducts
  }

  // Executa a função de receber os itens da API e salvar como .json e gera uma lista tratada a partir das informações obtidas
  fetchProducts().then(products => {

    let listIteration = []; // Lista que irá guardar todos os nomes (sem a cor) de produtos já processados

    products.forEach(product => {
      // -> extrair a string de cor do nome do produto,
      product.color_variations = product.name.split(/\b(Compressão |Suplex Poliamida |Dryfit |Tule | Trilobal |Jacquard Ondinha |Jacquard Zig |Jacquard Zebra |Jacquard Boreal |Jacquard Spot |Jacquard Chevry )\b/gm).pop();

      // -> extrair a informação de nome do produto até o nome do tecido, e gravar na variavel "name"
      let name = product.name.split(" " + product.color_variations).shift()

      let variationColor = {
        color_name: product.color_variations,
        images: product.images,
        slug: product.slug,
        permalink: product.permalink,
        // date_created: product.date_created,
      }

      let productNew = {
        id: product.id,
        name: name,
        status: product.status,
        sku: product.sku,
        price: product.price,
        price_sale: product.price_sale,
        price_interest: product.price_interest,
        price_interest_sale: product.price_interest_sale,
        on_sale: product.on_sale,
        // stock_status: product.stock_status,
        categories: product.categories,
        images: product.images,
        attributes: product.attributes,
        color_variations: []
      }

      // Caso o nome não exista na lista de iteração, fazer algumas coisas
      if (listIteration.indexOf(name) === -1) {

        // Registrar nome na lista de iteração para as próximas conferências em 'products'
        listIteration.push(name = name);

        productNew.color_variations.push(variationColor);
        productsClean.push(productNew);
      }
      else
      {
        productsClean[productsClean.length - 1].color_variations.push(variationColor);
      }
    });

    // Renderizar itens da lista em HTML com informações estruturadas de produtos
    const renderListedProducts = (array) => {
      const listItemHTML = array
        .map((product) => {
          return `
            <article
              class="wrapper-product"
              data-product-name="${product.name}"
              data-variation-name="${product.color_variations[0].color_name}"
            >
              <header>
                <h2 class="h5">${product.name} <span class="variation-name">${product.color_variations[0].color_name}</span></h2>
              </header>
              <div class="product-prices">
                <span class="product-price">R$ <span class="product-price-value">${product.price}</span></span>
                <span class="product-price-details">no PIX, ou até 3× de R$ <span class="product-price-3x-value">${product.price * 1.1 / 3}</span></span>
              </div>
              <div class="wrapper-swatches-color">
                <div class="swatch-color"></div>
                <div class="swatch-color"></div>
                <div class="swatch-color"></div>
                <div class="swatch-color"></div>
              </div>
              <div class="wrapper-swatches-size">
                <div class="swatch-size">P</div>
                <div class="swatch-size">M</div>
                <div class="swatch-size">G</div>
                <div class="swatch-size">GG</div>
              </div>
              <div class="swiper">
                <div class="swiper-wrapper">
                  <div class="swiper-slide">
                    <img src="${product.color_variations[0].images[0].src}" width="1600" height="1600" class="image-product" alt="" loading="lazy">
                  </div>
                </div>
              </div>
              <div class="wrapper-actions">
                <a class="btn btn-md btn-primary" href="https://api.whatsapp.com/send?phone=5527${whatsappNumber}&text=Gostaria%20de%20mais%20informações%20sobre%20${product.name}%20${product.color_variations[0].color_name},%20${product.color_variations[0].images[0].src}" target="blank">Comprar com atendente</a>
              </div>
            </article>
          `
        })
        .join("");
        list.innerHTML = listItemHTML;
    }
    renderListedProducts(productsClean);

  });

  const swiper = new Swiper('.swiper', {
    // Optional parameters
    direction: 'horizontal',
    spaceBetween: 8,

    // If we need pagination
    pagination: {
      el: '.swiper-pagination',
    },

    // Navigation arrows
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
  });
</script>
</body>
</html>